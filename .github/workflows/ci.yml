name: CI - Tests et Build

# DÃ©clenche le workflow sur push et pull request vers main
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

# Variables d'environnement globales
env:
  NODE_VERSION: '18'

jobs:
  # Job 1 : Frontend
  frontend:
    name: Frontend - Tests & Build
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
      
      - name: ğŸ” Linting du code
        run: npm run lint --if-present
        continue-on-error: true  # Ne bloque pas si lint Ã©choue
      
      - name: ğŸ§ª ExÃ©cution des tests
        run: npm test --if-present
        env:
          CI: true
      
      - name: ğŸ—ï¸ Build de production
        run: npm run build
      
      - name: ğŸ“¤ Upload des artefacts de build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build/
          retention-days: 7

  # Job 2 : Backend
  backend:
    name: Backend - Tests & VÃ©rifications
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./Atelier1.0
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: Atelier1.0/package-lock.json
      
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
      
      - name: ğŸ” Linting du code
        run: npm run lint --if-present
        continue-on-error: true
      
      - name: ğŸ§ª ExÃ©cution des tests
        run: npm test --if-present
        env:
          CI: true
      
      - name: âœ… VÃ©rification de la syntaxe
        run: node --check $(find . -name "*.js" -not -path "./node_modules/*")

  # Job 3 : RÃ©sumÃ© final
  ci-success:
    name: âœ… CI ComplÃ¨te
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: success()
    
    steps:
      - name: ğŸ‰ Tous les tests sont passÃ©s
        run: |
          echo "âœ… Frontend: OK"
          echo "âœ… Backend: OK"
          echo "ğŸ‰ CI complÃ¨te avec succÃ¨s!"